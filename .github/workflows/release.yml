name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "semver string for release e.g. 0.8.7"
        required: true
        type: string

jobs:

  sign-pack-upload:

    runs-on: [self-hosted]  # prefer macOS 12, Xcode 13.4.1
    env:
      KEYCHAIN: job-${{ github.job }}-${{ github.run_id	}}-${{ github.run_number }}-${{ github.run_attempt }}

    steps:

    - uses: actions/checkout@v2
      with:
        submodules: true

    # get copy of Mail.app since it's missing from the GitHub Actions runner images
    - name: checkout Mail.app
      uses: actions/checkout@v2
      with:
        repository: apparition47/Mail.app
        path: mail-app

    - uses: apple-actions/import-codesign-certs@v3
      with:
        keychain: ${{ env.KEYCHAIN }}
        # base64 enc of Developer ID Application + Developer ID Application with priv keys p12
        p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
        p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}


    - name: Checkout private Homebrew tap
      uses: actions/checkout@v2
      with:
        repository: apparition47/homebrew-tap
        path: apparition47-homebrew-tap
        token: ${{ secrets.REPO_PAT }} # repo scope

    - name: Update cask in Homebrew tap
      run: |
        CASK_NAME=mailtrackerblocker
        CASK_VERSION=${{ inputs.version }}
        CASK_SHA256=62b76c18d52789b0e80384781a9e0421effff5887677a4666c4d085c2b6659ea

        brew update
        brew tap homebrew/cask --force
        brew bump-cask-pr --no-browse --sha256 ${CASK_SHA256} --version ${CASK_VERSION} --no-audit --no-style ${CASK_NAME}

        cd apparition47-homebrew-tap
        git config --local user.name "${USER_NAME}"
        git config --local user.email "${USER_NAME}@users.noreply.github.com"
        sed -i '' "s/\( *version *\"\)\([^\"]*\)\"/\1${CASK_VERSION}\"/" Casks/${CASK_NAME}.rb
        sed -i '' "s/\( *sha256 *\"\)\([^\"]*\)\"/\1${CASK_SHA256}\"/" Casks/${CASK_NAME}.rb
        git add Casks/${CASK_NAME}.rb
        git commit -m "update ${CASK_NAME} to v${CASK_VERSION}"
        git push origin
      env:
        HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }} # repo:public_repo, workflow scope
        USER_NAME: ${{ secrets.GH_USERNAME }}

    - name: Delete keychain
      if: always() # Always run this step to ensure the keychain is properly disposed of
      run: |
        security delete-keychain "${{ env.KEYCHAIN }}".keychain
